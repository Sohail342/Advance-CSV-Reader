{% extends "base.html" %}

{% block title %}CSV/Excel File Viewer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-table me-2"></i>CSV/Excel File Viewer
                    </h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm" id="uploadBtn" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-1"></i>Upload File
                        </button>
                        <button class="btn btn-success btn-sm" id="downloadBtn" disabled>
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="refreshBtn" disabled>
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-0 text-muted">
                        Upload CSV or Excel files to view, filter, and download data. 
                        Supports files up to 100MB with automatic encoding detection.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- File Info Section -->
    <div class="row mb-4" id="fileInfoSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>File Information
                    </h5>
                    <button class="btn btn-outline-danger btn-sm" id="deleteFileBtn">
                        <i class="fas fa-trash me-1"></i>Delete File
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Filename:</strong>
                            <div id="fileName" class="text-truncate" title=""></div>
                        </div>
                        <div class="col-md-3">
                            <strong>Rows:</strong>
                            <div id="rowCount">-</div>
                        </div>
                        <div class="col-md-3">
                            <strong>Columns:</strong>
                            <div id="columnCount">-</div>
                        </div>
                        <div class="col-md-3">
                            <strong>Upload Time:</strong>
                            <div id="uploadTime">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="row mb-4" id="filtersSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Column Filters
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" id="addFilterBtn">
                                <i class="fas fa-plus me-1"></i>Add Filter
                            </button>
                            <button class="btn btn-outline-warning btn-sm" id="clearFiltersBtn">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                            <button class="btn btn-primary btn-sm" id="applyFiltersBtn">
                                <i class="fas fa-search me-1"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="filterContainer">
                        <!-- Filter rows will be added here dynamically -->
                    </div>
                    <div class="alert alert-info mt-3" id="filterStatus" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="filterStatusText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="row mb-4" id="dataSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>Data Preview
                        <span class="badge bg-light text-dark ms-2" id="visibleRowCount">0</span>
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0 text-white">Show:</label>
                            <select class="form-select form-select-sm" id="recordsPerPage" style="width: auto;">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                                <option value="500">500</option>
                            </select>
                        </div>
                        <div class="text-white small">
                            <span id="paginationInfo">0-0 of 0</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center p-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading data...</p>
                    </div>

                    <!-- Data Table -->
                    <div class="table-responsive" id="tableContainer" style="display: none;">
                        <table class="table table-striped table-hover mb-0" id="dataTable">
                            <thead class="table-dark sticky-top">
                                <tr id="tableHeader">
                                    <!-- Table headers will be added here dynamically -->
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Table rows will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- No Data Message -->
                    <div id="noDataMessage" class="text-center p-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No data to display</h5>
                        <p class="text-muted">Upload a CSV or Excel file to get started.</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="card-footer bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <small class="text-muted" id="tableInfo">
                                Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> entries
                            </small>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Data pagination">
                                <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                                    <!-- Pagination will be populated here dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>Upload CSV/Excel File
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Upload Zone -->
                    <div class="upload-zone p-4 text-center mb-3" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5 class="mb-2">Drop your file here or click to browse</h5>
                        <p class="text-muted mb-3">Supports CSV, XLS, XLSX files up to 100MB</p>
                        <input type="file" class="d-none" id="fileInput" accept=".csv,.xlsx,.xls" required>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </div>
                    
                    <!-- File Info -->
                    <div id="uploadFileInfo" class="alert alert-info d-none">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file me-2"></i>
                            <div>
                                <strong id="uploadFileName">No file selected</strong>
                                <br>
                                <small class="text-muted" id="uploadFileSize"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="progress mb-3" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar">
                            0%
                        </div>
                    </div>

                    <!-- Upload Status -->
                    <div id="uploadStatus" class="alert d-none">
                        <span id="uploadStatusText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadSubmitBtn" disabled>
                        <i class="fas fa-upload me-2"></i>Upload File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal fade" id="downloadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2"></i>Download Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Choose the format for downloading your data:</p>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="downloadFormat" id="csvFormat" value="csv" checked>
                        <label class="form-check-label" for="csvFormat">
                            <i class="fas fa-file-csv me-2"></i>CSV Format (.csv)
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="downloadFormat" id="excelFormat" value="xlsx">
                        <label class="form-check-label" for="excelFormat">
                            <i class="fas fa-file-excel me-2"></i>Excel Format (.xlsx)
                        </label>
                    </div>
                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="downloadInfo">Download will include all currently visible data with applied filters.</span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="downloadConfirmBtn">
                        <i class="fas fa-download me-2"></i>Download
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class FileViewer {
    constructor() {
        this.currentFileId = null;
        this.currentPage = 1;
        this.recordsPerPage = 50;
        this.filters = [];
        this.columns = [];
        this.sortColumn = null;
        this.sortOrder = 'asc';
        this.isFiltered = false;
        
        this.initializeEventListeners();
        this.initializeDragAndDrop();
    }

    initializeEventListeners() {
        // File input
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // Upload button
        document.getElementById('uploadSubmitBtn').addEventListener('click', () => this.uploadFile());

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => this.loadData());

        // Records per page
        document.getElementById('recordsPerPage').addEventListener('change', (e) => {
            this.recordsPerPage = parseInt(e.target.value);
            this.currentPage = 1;
            this.loadData();
        });

        // Download button
        document.getElementById('downloadBtn').addEventListener('click', () => this.showDownloadModal());
        document.getElementById('downloadConfirmBtn').addEventListener('click', () => this.downloadFile());

        // Delete file button
        document.getElementById('deleteFileBtn').addEventListener('click', () => this.deleteFile());

        // Filter buttons
        document.getElementById('addFilterBtn').addEventListener('click', () => this.addFilterRow());
        document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearFilters());
        document.getElementById('applyFiltersBtn').addEventListener('click', () => this.applyFilters());

        // Modal events
        const uploadModal = document.getElementById('uploadModal');
        uploadModal.addEventListener('hidden.bs.modal', () => this.resetUploadModal());
    }

    initializeDragAndDrop() {
        const uploadZone = document.getElementById('uploadZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, this.preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => uploadZone.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('drag-over'), false);
        });

        uploadZone.addEventListener('drop', (e) => this.handleDrop(e), false);
    }

    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            this.processFile(files[0]);
        }
    }

    handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            this.processFile(file);
        }
    }

    processFile(file) {
        // Validate file
        const validTypes = ['.csv', '.xlsx', '.xls'];
        const fileName = file.name.toLowerCase();
        const isValid = validTypes.some(type => fileName.endsWith(type));

        if (!isValid) {
            this.showUploadStatus('Please select a valid CSV or Excel file.', 'danger');
            return;
        }

        if (file.size > 100 * 1024 * 1024) { // 100MB limit
            this.showUploadStatus('File size must not exceed 100MB.', 'danger');
            return;
        }

        // Show file info
        document.getElementById('uploadFileName').textContent = file.name;
        document.getElementById('uploadFileSize').textContent = this.formatFileSize(file.size);
        document.getElementById('uploadFileInfo').classList.remove('d-none');
        document.getElementById('uploadSubmitBtn').disabled = false;

        // Store file for upload
        this.selectedFile = file;
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async uploadFile() {
        if (!this.selectedFile) return;

        const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
        const progressBar = document.getElementById('progressBar');
        const uploadProgress = document.getElementById('uploadProgress');

        // Disable button and show progress
        uploadSubmitBtn.disabled = true;
        uploadProgress.style.display = 'block';

        // Create form data
        const formData = new FormData();
        formData.append('file', this.selectedFile);

        try {
            const response = await fetch('/file-viewer/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                this.showUploadStatus(result.message, 'success');
                this.currentFileId = result.file_id;
                this.loadFileInfo(result);
                this.loadColumns();
                this.loadData();
                
                // Close modal after delay
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                }, 1500);
            } else {
                const error = await response.json();
                this.showUploadStatus(error.detail || 'Upload failed', 'danger');
            }
        } catch (error) {
            console.error('Upload error:', error);
            this.showUploadStatus('Upload failed. Please try again.', 'danger');
        } finally {
            uploadSubmitBtn.disabled = false;
            uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }
    }

    showUploadStatus(message, type) {
        const statusDiv = document.getElementById('uploadStatus');
        const statusText = document.getElementById('uploadStatusText');
        
        statusText.textContent = message;
        statusDiv.className = `alert alert-${type}`;
        statusDiv.classList.remove('d-none');
    }

    resetUploadModal() {
        document.getElementById('uploadFileInfo').classList.add('d-none');
        document.getElementById('uploadSubmitBtn').disabled = true;
        document.getElementById('uploadStatus').classList.add('d-none');
        document.getElementById('fileInput').value = '';
        this.selectedFile = null;
    }

    loadFileInfo(fileData) {
        document.getElementById('fileName').textContent = fileData.filename;
        document.getElementById('rowCount').textContent = fileData.row_count.toLocaleString();
        document.getElementById('columnCount').textContent = fileData.columns.length;
        document.getElementById('uploadTime').textContent = new Date().toLocaleString();
        
        document.getElementById('fileInfoSection').style.display = 'block';
        document.getElementById('filtersSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'block';
        document.getElementById('refreshBtn').disabled = false;
        document.getElementById('downloadBtn').disabled = false;
    }

    async loadColumns() {
        if (!this.currentFileId) return;

        try {
            const response = await fetch(`/file-viewer/columns/${this.currentFileId}`);
            if (response.ok) {
                const result = await response.json();
                this.columns = result.columns;
                this.populateFilterOptions();
            }
        } catch (error) {
            console.error('Error loading columns:', error);
        }
    }

    populateFilterOptions() {
        // This will be used when adding filter rows
    }

    addFilterRow() {
        const filterContainer = document.getElementById('filterContainer');
        const filterId = `filter_${Date.now()}`;
        
        const filterRow = document.createElement('div');
        filterRow.className = 'row g-2 mb-2 filter-row';
        filterRow.id = filterId;
        
        filterRow.innerHTML = `
            <div class="col-md-4">
                <select class="form-select column-select">
                    <option value="">Select Column</option>
                    ${this.columns.map(col => `<option value="${col.name}">${col.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select filter-type-select">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="not_empty">Not Empty</option>
                    <option value="is_empty">Is Empty</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control filter-value" placeholder="Enter value...">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.filter-row').remove()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        filterContainer.appendChild(filterRow);
    }

    clearFilters() {
        document.getElementById('filterContainer').innerHTML = '';
        this.filters = [];
        this.isFiltered = false;
        this.currentPage = 1;
        this.loadData();
    }

    async applyFilters() {
        const filterRows = document.querySelectorAll('.filter-row');
        const filters = {};
        
        filterRows.forEach(row => {
            const column = row.querySelector('.column-select').value;
            const filterType = row.querySelector('.filter-type-select').value;
            const filterValue = row.querySelector('.filter-value').value;
            
            if (column && filterType) {
                filters[column] = {
                    type: filterType,
                    value: filterValue
                };
            }
        });
        
        if (Object.keys(filters).length === 0) {
            this.showFilterStatus('Please add at least one filter condition.', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/file-viewer/filter/${this.currentFileId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filters)
            });
            
            if (response.ok) {
                const result = await response.json();
                this.currentFileId = result.filtered_file_id;
                this.isFiltered = true;
                this.currentPage = 1;
                this.loadData();
                this.showFilterStatus(result.message, 'success');
            } else {
                const error = await response.json();
                this.showFilterStatus(error.detail || 'Filter application failed', 'danger');
            }
        } catch (error) {
            console.error('Filter error:', error);
            this.showFilterStatus('Failed to apply filters. Please try again.', 'danger');
        }
    }

    showFilterStatus(message, type) {
        const statusDiv = document.getElementById('filterStatus');
        const statusText = document.getElementById('filterStatusText');
        
        statusText.textContent = message;
        statusDiv.className = `alert alert-${type}`;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }

    async loadData() {
        if (!this.currentFileId) return;

        this.showLoading(true);
        
        try {
            const params = new URLSearchParams({
                page: this.currentPage,
                per_page: this.recordsPerPage
            });
            
            if (this.sortColumn) {
                params.append('sort_column', this.sortColumn);
                params.append('sort_order', this.sortOrder);
            }
            
            const response = await fetch(`/file-viewer/data/${this.currentFileId}?${params}`);
            
            if (response.ok) {
                const result = await response.json();
                this.displayData(result);
            } else {
                const error = await response.json();
                this.showError(error.detail || 'Failed to load data');
            }
        } catch (error) {
            console.error('Load data error:', error);
            this.showError('Failed to load data. Please try again.');
        } finally {
            this.showLoading(false);
        }
    }

    displayData(data) {
        // Update table header
        const tableHeader = document.getElementById('tableHeader');
        tableHeader.innerHTML = data.columns.map(col => 
            `<th class="sortable" data-column="${col}">
                ${col}
                <i class="fas fa-sort ms-1"></i>
            </th>`
        ).join('');
        
        // Add sort listeners
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (this.sortColumn === column) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = column;
                    this.sortOrder = 'asc';
                }
                this.loadData();
            });
        });
        
        // Update table body
        const tableBody = document.getElementById('tableBody');
        if (data.data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted">No data to display</td></tr>';
        } else {
            tableBody.innerHTML = data.data.map(row => 
                `<tr>${data.columns.map(col => 
                    `<td>${this.formatCellValue(row[col])}</td>`
                ).join('')}</tr>`
            ).join('');
        }
        
        // Update pagination
        this.updatePagination(data.pagination);
        
        // Update info
        this.updateTableInfo(data.pagination);
        
        // Show table
        document.getElementById('tableContainer').style.display = 'block';
        document.getElementById('noDataMessage').style.display = 'none';
    }

    formatCellValue(value) {
        if (value === null || value === undefined) return '<span class="text-muted">-</span>';
        if (value === true) return '<i class="fas fa-check text-success"></i>';
        if (value === false) return '<i class="fas fa-times text-danger"></i>';
        if (typeof value === 'number') return value.toLocaleString();
        if (value.length > 50) return value.substring(0, 50) + '...';
        return value;
    }

    updatePagination(pagination) {
        const paginationElement = document.getElementById('pagination');
        
        if (pagination.total_pages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        if (pagination.current_page > 1) {
            html += `<li class="page-item">
                <a class="page-link" href="#" data-page="${pagination.current_page - 1}">Previous</a>
            </li>`;
        }
        
        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, pagination.current_page - Math.floor(maxPages / 2));
        let endPage = Math.min(pagination.total_pages, startPage + maxPages - 1);
        
        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>`;
        }
        
        // Next button
        if (pagination.current_page < pagination.total_pages) {
            html += `<li class="page-item">
                <a class="page-link" href="#" data-page="${pagination.current_page + 1}">Next</a>
            </li>`;
        }
        
        paginationElement.innerHTML = html;
        
        // Add click listeners
        paginationElement.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.currentPage = parseInt(e.target.dataset.page);
                this.loadData();
            });
        });
    }

    updateTableInfo(pagination) {
        document.getElementById('startRecord').textContent = pagination.start_index.toLocaleString();
        document.getElementById('endRecord').textContent = pagination.end_index.toLocaleString();
        document.getElementById('totalRecords').textContent = pagination.total_rows.toLocaleString();
        document.getElementById('visibleRowCount').textContent = pagination.total_rows.toLocaleString();
    }

    showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        document.getElementById('tableContainer').style.display = show ? 'none' : 'block';
    }

    showError(message) {
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('noDataMessage').innerHTML = `
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">Error</h5>
            <p class="text-muted">${message}</p>
        `;
    }

    showDownloadModal() {
        const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
        modal.show();
    }

    async downloadFile() {
        const format = document.querySelector('input[name="downloadFormat"]:checked').value;
        
        if (!this.currentFileId) return;
        
        try {
            const response = await fetch(`/file-viewer/download/${this.currentFileId}?format=${format}`);
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || `data.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('downloadModal')).hide();
            } else {
                const error = await response.json();
                alert(`Download failed: ${error.detail || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Download error:', error);
            alert('Download failed. Please try again.');
        }
    }

    async deleteFile() {
        if (!this.currentFileId) return;
        
        if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
            try {
                const response = await fetch(`/file-viewer/files/${this.currentFileId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Reset UI
                    this.currentFileId = null;
                    document.getElementById('fileInfoSection').style.display = 'none';
                    document.getElementById('filtersSection').style.display = 'none';
                    document.getElementById('dataSection').style.display = 'none';
                    document.getElementById('refreshBtn').disabled = true;
                    document.getElementById('downloadBtn').disabled = true;
                    
                    alert('File deleted successfully.');
                } else {
                    const error = await response.json();
                    alert(`Delete failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Delete failed. Please try again.');
            }
        }
    }
}

// Initialize the file viewer when the page loads
document.addEventListener('DOMContentLoaded', function() {
    window.fileViewer = new FileViewer();
});
</script>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-zone:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.upload-zone.drag-over {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.table-responsive {
    max-height: 600px;
    overflow: auto;
}

.filter-row {
    align-items: center;
}

@media (max-width: 768px) {
    .card-header .d-flex {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}