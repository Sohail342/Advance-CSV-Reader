{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-table me-2"></i>Database Records Viewer
                    </h4>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-1"></i>Upload & Process
                    </button>
                </div>
                <div class="card-body">
                    <p class="mb-0 text-muted">View and filter all CSV headers data from the database. Upload new files to process and generate comparison reports.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                        <button class="btn btn-sm btn-outline-secondary float-end" id="clearFiltersBtn">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Search Input -->
                        <div class="col-md-6 col-lg-3">
                            <label for="searchInput" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search all fields...">
                        </div>
                        
                        <!-- Cost Center ID Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label for="costCenterFilter" class="form-label">Cost Center ID</label>
                            <select class="form-select" id="costCenterFilter">
                                <option value="">All Cost Centers</option>
                            </select>
                        </div>
                        
                        <!-- Region Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label for="regionFilter" class="form-label">Region</label>
                            <select class="form-select" id="regionFilter">
                                <option value="">All Regions</option>
                            </select>
                        </div>
                        
                        <!-- B Code Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label for="bCodeFilter" class="form-label">B Code</label>
                            <select class="form-select" id="bCodeFilter">
                                <option value="">All B Codes</option>
                            </select>
                        </div>
                        
                        <!-- SubGL Code Input -->
                        <div class="col-md-6 col-lg-3">
                            <label for="subGLCodeInput" class="form-label">SubGL Code</label>
                            <input type="text" class="form-control" id="subGLCodeInput" placeholder="Enter SubGL Code...">
                        </div>
                        
                        <!-- Records per page -->
                        <div class="col-md-6 col-lg-3">
                            <label for="recordsPerPage" class="form-label">Records per page</label>
                            <select class="form-select" id="recordsPerPage">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>Records
                        <span class="badge bg-light text-dark ms-2" id="recordCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-light" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body p-0">
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center p-4 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading data...</p>
                    </div>

                    <!-- Data Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="dataTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>ID</th>
                                    <th>Cost Center ID</th>
                                    <th>SubGL Code</th>
                                    <th>SubHead ID</th>
                                    <th>SubHead</th>
                                    <th>Region</th>
                                    <th>B Code</th>
                                    <th>B Name</th>
                                    <th>Budget ID</th>
                                    <th>Head</th>
                                    <th>Head ID</th>
                                    <th>Cost Center</th>
                                    <th>Budget Amount</th>
                                    <th>Validity Date</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- No Data Message -->
                    <div id="noDataMessage" class="text-center p-4 d-none">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No records found</h5>
                        <p class="text-muted">Try adjusting your filters or search criteria.</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="card-footer bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <small class="text-muted" id="paginationInfo">
                                Showing 0 to 0 of 0 entries
                            </small>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Data pagination">
                                <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                                    <!-- Pagination will be populated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload & Process CSV/Excel File
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadForm" action="/csv/upload" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <!-- Upload Zone -->
                            <div class="upload-zone p-4 text-center mb-3" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="mb-2">Drop file here or click to browse</h5>
                                <p class="text-muted mb-3">Supports CSV, XLS, XLSX files</p>
                                <input type="file" class="d-none" id="fileInput" name="file" accept=".csv,.xlsx,.xls" required>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open me-1"></i>Choose File
                                </button>
                            </div>
                            
                            <!-- File Info -->
                            <div id="fileInfo" class="alert alert-info d-none">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file me-2"></i>
                                    <div>
                                        <strong id="fileName">No file selected</strong>
                                        <br>
                                        <small class="text-muted" id="fileSize"></small>
                                    </div>
                                </div>
                            </div>

                            <!-- Required Headers Info -->
                            <div class="alert alert-warning">
                                <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-1"></i>Required Headers</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Must contain:</strong>
                                        <ul class="mb-0 small">
                                            <li><code>SubGLCode</code></li>
                                            <li><code>BCode</code></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Optional fields:</strong>
                                        <ul class="mb-0 small">
                                            <li><code>CostCenterID</code></li>
                                            <li><code>Region</code></li>
                                            <li><code>BudgetAmount</code></li>
                                            <li>And other fields...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        <i class="fas fa-upload me-1"></i>Upload & Process
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <h5>Processing your file...</h5>
                <p class="text-muted mb-0">This may take a few moments depending on file size.</p>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">An error occurred while loading data.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class DataViewer {
    constructor() {
        this.currentPage = 1;
        this.currentLimit = 50;
        this.currentFilters = {};
        this.filterOptions = {};
        
        this.initializeElements();
        this.bindEvents();
        this.loadFilterOptions();
        this.loadData();
    }
    
    initializeElements() {
        this.searchInput = document.getElementById('searchInput');
        this.costCenterFilter = document.getElementById('costCenterFilter');
        this.regionFilter = document.getElementById('regionFilter');
        this.bCodeFilter = document.getElementById('bCodeFilter');
        this.subGLCodeInput = document.getElementById('subGLCodeInput');
        this.recordsPerPage = document.getElementById('recordsPerPage');
        this.clearFiltersBtn = document.getElementById('clearFiltersBtn');
        this.refreshBtn = document.getElementById('refreshBtn');
        this.loadingSpinner = document.getElementById('loadingSpinner');
        this.dataTableBody = document.getElementById('dataTableBody');
        this.noDataMessage = document.getElementById('noDataMessage');
        this.recordCount = document.getElementById('recordCount');
        this.paginationInfo = document.getElementById('paginationInfo');
        this.pagination = document.getElementById('pagination');
        this.errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        this.errorMessage = document.getElementById('errorMessage');
        
        // Upload modal elements
        this.uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        this.processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
        this.uploadZone = document.getElementById('uploadZone');
        this.fileInput = document.getElementById('fileInput');
        this.fileInfo = document.getElementById('fileInfo');
        this.fileName = document.getElementById('fileName');
        this.fileSize = document.getElementById('fileSize');
        this.uploadBtn = document.getElementById('uploadBtn');
        this.uploadForm = document.getElementById('uploadForm');
    }
    
    bindEvents() {
        // Debounced search input
        let searchTimeout;
        this.searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => this.applyFilters(), 500);
        });
        
        // Debounced SubGL Code input
        let subGLTimeout;
        this.subGLCodeInput.addEventListener('input', () => {
            clearTimeout(subGLTimeout);
            subGLTimeout = setTimeout(() => this.applyFilters(), 500);
        });
        
        // Filter dropdowns
        this.costCenterFilter.addEventListener('change', () => this.applyFilters());
        this.regionFilter.addEventListener('change', () => this.applyFilters());
        this.bCodeFilter.addEventListener('change', () => this.applyFilters());
        
        // Records per page
        this.recordsPerPage.addEventListener('change', () => {
            this.currentLimit = parseInt(this.recordsPerPage.value);
            this.currentPage = 1;
            this.loadData();
        });
        
        // Clear filters
        this.clearFiltersBtn.addEventListener('click', () => this.clearFilters());
        
        // Refresh
        this.refreshBtn.addEventListener('click', () => this.loadData());
        
        // Upload functionality
        this.initializeUploadEvents();
    }
    
    initializeUploadEvents() {
        // File input change
        this.fileInput.addEventListener('change', () => this.handleFileSelect(this.fileInput.files));
        
        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            this.uploadZone.addEventListener(eventName, this.preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            this.uploadZone.addEventListener(eventName, () => this.uploadZone.classList.add('dragover'));
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            this.uploadZone.addEventListener(eventName, () => this.uploadZone.classList.remove('dragover'));
        });
        
        this.uploadZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            this.handleFileSelect(files);
        });
        
        // Form submission
        this.uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (this.fileInput.files.length > 0) {
                this.uploadModal.hide();
                this.processingModal.show();
                this.uploadForm.submit();
            }
        });
    }
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    handleFileSelect(files) {
        if (files.length > 0) {
            const file = files[0];
            const validTypes = ['.csv', '.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (validTypes.includes(fileExtension)) {
                this.fileName.textContent = file.name;
                this.fileSize.textContent = this.formatFileSize(file.size);
                this.fileInfo.classList.remove('d-none');
                this.uploadBtn.disabled = false;
            } else {
                alert('Please select a valid CSV or Excel file.');
                this.fileInput.value = '';
                this.fileInfo.classList.add('d-none');
                this.uploadBtn.disabled = true;
            }
        }
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async loadFilterOptions() {
        try {
            const response = await fetch('/csv/api/filter-options');
            if (!response.ok) throw new Error('Failed to load filter options');
            
            this.filterOptions = await response.json();
            this.populateFilterDropdowns();
        } catch (error) {
            console.error('Error loading filter options:', error);
        }
    }
    
    populateFilterDropdowns() {
        // Populate Cost Center dropdown
        this.costCenterFilter.innerHTML = '<option value="">All Cost Centers</option>';
        this.filterOptions.cost_centers.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            this.costCenterFilter.appendChild(optionElement);
        });
        
        // Populate Region dropdown
        this.regionFilter.innerHTML = '<option value="">All Regions</option>';
        this.filterOptions.regions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            this.regionFilter.appendChild(optionElement);
        });
        
        // Populate B Code dropdown
        this.bCodeFilter.innerHTML = '<option value="">All B Codes</option>';
        this.filterOptions.b_codes.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            this.bCodeFilter.appendChild(optionElement);
        });
    }
    
    applyFilters() {
        this.currentPage = 1;
        this.loadData();
    }
    
    clearFilters() {
        this.searchInput.value = '';
        this.costCenterFilter.value = '';
        this.regionFilter.value = '';
        this.bCodeFilter.value = '';
        this.subGLCodeInput.value = '';
        this.currentPage = 1;
        this.loadData();
    }
    
    async loadData() {
        this.showLoading(true);
        
        try {
            const params = new URLSearchParams({
                page: this.currentPage,
                limit: this.currentLimit
            });
            
            // Add filters
            if (this.searchInput.value.trim()) {
                params.append('search', this.searchInput.value.trim());
            }
            if (this.costCenterFilter.value) {
                params.append('cost_center_id', this.costCenterFilter.value);
            }
            if (this.regionFilter.value) {
                params.append('region', this.regionFilter.value);
            }
            if (this.bCodeFilter.value) {
                params.append('b_code', this.bCodeFilter.value);
            }
            if (this.subGLCodeInput.value.trim()) {
                params.append('sub_gl_code', this.subGLCodeInput.value.trim());
            }
            
            const response = await fetch(`/csv/api/data?${params}`);
            if (!response.ok) throw new Error('Failed to load data');
            
            const result = await response.json();
            this.renderData(result);
            
        } catch (error) {
            console.error('Error loading data:', error);
            this.showError('Failed to load data. Please try again.');
        } finally {
            this.showLoading(false);
        }
    }
    
    renderData(result) {
        const { data, pagination } = result;
        
        // Update record count
        this.recordCount.textContent = pagination.total;
        
        // Clear table body
        this.dataTableBody.innerHTML = '';
        
        if (data.length === 0) {
            this.noDataMessage.classList.remove('d-none');
            return;
        }
        
        this.noDataMessage.classList.add('d-none');
        
        // Populate table
        data.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${record.id || ''}</td>
                <td>${record.CostCenterID || ''}</td>
                <td>${record.SubGLCode || ''}</td>
                <td>${record.SubHeadID || ''}</td>
                <td>${record.SubHead || ''}</td>
                <td>${record.Region || ''}</td>
                <td>${record.BCode || ''}</td>
                <td>${record.BName || ''}</td>
                <td>${record.BudgetID || ''}</td>
                <td>${record.Head || ''}</td>
                <td>${record.HeadID || ''}</td>
                <td>${record.CostCenter || ''}</td>
                <td>${record.BudgetAmount || ''}</td>
                <td>${record.ValidityDate || ''}</td>
                <td>${record.Description || ''}</td>
            `;
            this.dataTableBody.appendChild(row);
        });
        
        // Update pagination info
        const start = (pagination.page - 1) * pagination.limit + 1;
        const end = Math.min(pagination.page * pagination.limit, pagination.total);
        this.paginationInfo.textContent = `Showing ${start} to ${end} of ${pagination.total} entries`;
        
        // Render pagination
        this.renderPagination(pagination);
    }
    
    renderPagination(pagination) {
        this.pagination.innerHTML = '';
        
        if (pagination.pages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${pagination.page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.page - 1}">Previous</a>`;
        this.pagination.appendChild(prevLi);
        
        // Page numbers
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.pages, pagination.page + 2);
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            this.pagination.appendChild(firstLi);
            
            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                this.pagination.appendChild(ellipsisLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === pagination.page ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            this.pagination.appendChild(pageLi);
        }
        
        if (endPage < pagination.pages) {
            if (endPage < pagination.pages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                this.pagination.appendChild(ellipsisLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.pages}">${pagination.pages}</a>`;
            this.pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${pagination.page === pagination.pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.page + 1}">Next</a>`;
        this.pagination.appendChild(nextLi);
        
        // Bind pagination events
        this.pagination.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.tagName === 'A' && e.target.dataset.page) {
                const page = parseInt(e.target.dataset.page);
                if (page !== this.currentPage && page >= 1 && page <= pagination.pages) {
                    this.currentPage = page;
                    this.loadData();
                }
            }
        });
    }
    
    showLoading(show) {
        if (show) {
            this.loadingSpinner.classList.remove('d-none');
            this.noDataMessage.classList.add('d-none');
        } else {
            this.loadingSpinner.classList.add('d-none');
        }
    }
    
    showError(message) {
        this.errorMessage.textContent = message;
        this.errorModal.show();
    }
}

// Initialize the data viewer when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new DataViewer();
});
</script>
{% endblock %}
